name: CI

on:
  push:
    branches: [ main, clean-main, develop ]
  pull_request:
    branches: [ main, clean-main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ============================================
  # BUILD JOB
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.gradle.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/clean-main' }}
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build project
        run: ./gradlew build --no-daemon --stacktrace

      - name: Get project version
        id: gradle
        run: |
          VERSION=$(./gradlew properties --no-daemon -q | grep "^version:" | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Project version: $VERSION"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/libs/*.jar
            !build/libs/*-sources.jar
            !build/libs/*-javadoc.jar
          retention-days: 7

  # ============================================
  # TEST JOB
  # ============================================
  test:
    name: Test (Java ${{ matrix.java }})
    runs-on: ubuntu-latest
    needs: build

    strategy:
      fail-fast: false
      matrix:
        java: ['17', '21']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test --no-daemon --stacktrace --continue

      - name: Generate test report
        if: always()
        run: ./gradlew testReport --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-java-${{ matrix.java }}
          path: |
            build/reports/tests/
            build/test-results/
          retention-days: 14

      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results (Java ${{ matrix.java }})
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Check test failures
        if: failure()
        run: |
          echo "::error::Tests failed on Java ${{ matrix.java }}"
          ./gradlew test --no-daemon --info || true

  # ============================================
  # COVERAGE JOB
  # ============================================
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Generate Jacoco coverage report
        run: ./gradlew jacocoTestReport --no-daemon

      - name: Generate coverage summary
        id: coverage
        run: |
          REPORT=build/reports/jacoco/test/html/index.html
          if [ -f "$REPORT" ]; then
            INSTRUCTION_MISSED=$(grep -o 'Total[^%]*%[^%]*%' "$REPORT" | grep 'Missed' | grep -o '[0-9]*%' | head -1 || echo "N/A")
            INSTRUCTION_COVERED=$(grep -o 'Total[^%]*%[^%]*%' "$REPORT" | grep 'Covered' | grep -o '[0-9]*%' | head -1 || echo "N/A")
            echo "instruction_missed=$INSTRUCTION_MISSED" >> $GITHUB_OUTPUT
            echo "instruction_covered=$INSTRUCTION_COVERED" >> $GITHUB_OUTPUT
            echo "Coverage: $INSTRUCTION_COVERED covered, $INSTRUCTION_MISSED missed"
          else
            echo "::warning::Jacoco report not found"
            echo "instruction_covered=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: github.event_name != 'pull_request'
        with:
          files: build/reports/jacoco/test/jacocoTestReport.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/jacoco/
          retention-days: 14

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.coverage.outputs.instruction_covered }}';
            const body = `### Coverage Report
            - **Instruction Coverage:** ${coverage}
            - **Report:** [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            *Generated by CI pipeline*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================
  # STATIC ANALYSIS JOB
  # ============================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest --no-daemon --continue
        continue-on-error: true

      - name: Run SpotBugs
        run: ./gradlew spotbugsMain spotbugsTest --no-daemon --continue
        continue-on-error: true

      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: build/reports/checkstyle/
          retention-days: 14

      - name: Upload SpotBugs report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report
          path: build/reports/spotbugs/
          retention-days: 14

      - name: Analyze Checkstyle violations
        id: checkstyle
        if: always()
        run: |
          REPORT=build/reports/checkstyle/main.txt
          if [ -f "$REPORT" ]; then
            VIOLATIONS=$(grep -c "^\[" "$REPORT" 2>/dev/null || echo "0")
            echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
            if [ "$VIOLATIONS" -gt 0 ]; then
              echo "::warning::Checkstyle found $VIOLATIONS violations"
            fi
          else
            echo "violations=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment analysis on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const violations = ${{ steps.checkstyle.outputs.violations }};
            const body = `### Static Analysis Report
            - **Checkstyle Violations:** ${violations}
            - **SpotBugs Report:** Available in artifacts

            ${violations > 0 ? '⚠️ **Action Required:** Please fix code style violations' : '✅ **No issues found**'}

            *Generated by CI pipeline*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================
  # SECURITY SCAN JOB
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run dependency check
        run: ./gradlew dependencyCheckAnalyze --no-daemon
        continue-on-error: true

      - name: Upload dependency check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: build/reports/dependency-check-report.html
          retention-days: 30

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # BUILD SUMMARY JOB
  # ============================================
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, test, coverage, static-analysis]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate build summary
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: ${{ needs.coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Static Analysis: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -R >> $GITHUB_STEP_SUMMARY

      - name: Check job status
        if: |
          needs.build.result != 'success' ||
          needs.test.result != 'success' ||
          needs.coverage.result != 'success'
        run: |
          echo "::error::One or more jobs failed"
          exit 1
